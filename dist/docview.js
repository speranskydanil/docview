var Docview=function(){function Class(conf){var init=conf.init||function(){};delete conf.init;var parent=conf.parent||function(){};delete conf.parent;var F=function(){};F.prototype=parent.prototype;var f=new F;for(var fn in conf)f[fn]=conf[fn];init.prototype=f;return init}var Docview=new Class({init:function(params){var defaultParams={theme:"classic",translation:{grid:"Grid",filmstrip:"Filmstrip",inspect:"Inspect",flipBook:"Flip-book",fullscreen:"Fullscreen",zoomOut:"Zoom out",zoomIn:"Zoom in",dimTheLights:"Dim the lights",prevPage:"Previous page",nextPage:"Next page",rotateLeft:"Rotate left",rotateRight:"Rotate right",download:"Download",print:"Print"},index:0,mode:"grid",zoom:0,maxZoom:0};params=$.extend(true,defaultParams,params);this.buildDom(params);this.bindEvents(params);this.initializeModes(params);this.activateMode(params)},buildDom:function(params){var t=params.translation;html="<div class='docview "+params.theme+"'>"+"<div class='toolbar-wrapper'>"+"<div class='toolbar'>"+"<div class='modes'>"+"<a class='grid' title='"+t.grid+"'></a>"+"<a class='filmstrip' title='"+t.filmstrip+"'></a>"+"<a class='inspect' title='"+t.inspect+"'></a>"+"<a class='flip-book' title='"+t.flipBook+"'></a>"+"</div>"+"<div class='delimiter'></div>"+"<a class='fullscreen' title='"+t.fullscreen+"'></a>"+"<div class='delimiter'></div>"+"<div class='zoom'>"+"<a class='zoom-out' title='"+t.zoomOut+"'></a>"+"<a class='zoom-in' title='"+t.zoomIn+"'></a>"+"</div>"+"<div class='delimiter'></div>"+"<a class='dim' title='"+t.dimTheLights+"'></a>"+"<div class='delimiter delimiter-after-dim'></div>"+"<div class='paginator'>"+"<a class='prev' title='"+t.prevPage+"'></a>"+"<input class='cur' type='text'>"+"<a class='next' title='"+t.nextPage+"'></a>"+"</div>"+"<div class='delimiter delimiter-after-paginator'></div>"+"<div class='rotator'>"+"<a class='left' title='"+t.rotatLeft+"'></a>"+"<a class='right' title='"+t.rotateRight+"'></a>"+"</div>"+"<div class='delimiter delimiter-after-rotator'></div>"+"<a class='download' title='"+t.download+"' target='_blank' download></a>"+"<a class='print' title='"+t.print+"'></a>"+"</div>"+"<div class='toolbar-buttons'>"+(params.buttons||"")+"</div>"+"<div class='clear'></div>"+"</div>"+"<div class='wrapper'>"+"<div class='viewport'>"+"<div class='wrapper'>"+"htmlPages"+"<div class='clear'></div>"+"</div>"+"</div>"+"</div>"+"</div>";htmlPages="";for(var i=0,l=params.pages.length;i<l;i+=1){htmlPages+="<div class='page' id='page-"+params.pages[i].id+"'>"+"<img src='' oncontextmenu='return false' title='' alt=''>"+"</div>"}html=html.replace("htmlPages",htmlPages);params.div.html(html);this.dom={docview:$(".docview"),toolbarWrapper:$(".docview .toolbar-wrapper"),toolbar:$(".docview .toolbar"),modes:$(".docview .toolbar .modes a"),fullscreen:$(".docview .toolbar .fullscreen"),zoomIn:$(".docview .toolbar .zoom-in"),zoomOut:$(".docview .toolbar .zoom-out"),dim:$(".docview .toolbar .dim"),prev:$(".docview .toolbar .paginator .prev"),cur:$(".docview .toolbar .paginator .cur"),next:$(".docview .toolbar .paginator .next"),rotateLeft:$(".docview .toolbar .rotator .left"),rotateRight:$(".docview .toolbar .rotator .right"),download:$(".docview .toolbar .download"),print:$(".docview .toolbar .print"),toolbarButtons:$(".docview .toolbar-buttons"),viewport:$(".viewport"),wrapper:$(".viewport .wrapper"),pages:$(".viewport .page"),images:$(".viewport .page img")};this.dom.docview.find("*:not(input)").attr("unselectable","on").css("user-select","none").on("selectstart",false)},bindEvents:function(params){this.bindCommonEvents();this.bindToolbarEvents();this.bindModeEvents()},bindCommonEvents:function(){var self=this;$(window).scroll(function(){self.moveToolbar()});setInterval(function(){self.mode.load()},2e3)},bindToolbarEvents:function(){var self=this;this.dom.modes.click(function(e){e.preventDefault();self.changeMode($(this).attr("class"))});var fullscreen=false;var docview=this.dom.docview;var parent=docview.parent();this.dom.fullscreen.click(function(e){e.preventDefault();if(!fullscreen){$("body > *").each(function(){$(this).data("docview-display-cache",$(this).css("display"));$(this).css("display","none")});docview.appendTo("body").show()}else{$("body > *").each(function(){$(this).css("display",$(this).data("docview-display-cache"));$(this).removeData("docview-display-cache")});docview.appendTo(parent)}fullscreen=!fullscreen});this.dom.zoomIn.click(function(e){e.preventDefault();self.mode.zoomIn()});this.dom.zoomOut.click(function(e){e.preventDefault();self.mode.zoomOut()});this.dom.dim.click(function(e){e.preventDefault();$("body").toggleClass("dark")});this.dom.prev.click(function(e){e.preventDefault();self.mode.prev()});this.dom.cur.change(function(){self.mode.setCurPage(parseInt($(this).val())-1)});this.dom.next.click(function(e){e.preventDefault();self.mode.next()});this.dom.rotateLeft.click(function(e){e.preventDefault();self.mode.rotateLeft()});this.dom.rotateRight.click(function(e){e.preventDefault();self.mode.rotateRight()});this.dom.print.click(function(e){e.preventDefault();var w=window.open(self.mode.downloadUrl());$(w).ready(function(){w.print()})})},bindModeEvents:function(){var self=this;$(window).bind({"docview-select-cur-page":function(){self.changeMode("inspect")},"docview-mode-changed":function(){self.dom.docview.removeClass("grid filmstrip inspect flip-book").addClass(self.mode.name);if(self.mode.name=="inspect"){self.dom.cur.val(self.mode.index+1);self.dom.download.attr("href",self.mode.downloadUrl())}else if(self.mode.name=="flip-book"){if(self.mode.index==0){self.dom.cur.val(1)}else{var index_1=self.mode.index+self.mode.index%2;var index_2=index_1==self.mode.pages.length?"":" - "+(index_1+1);self.dom.cur.val(index_1+index_2)}}else if(self.mode.name=="filmstrip"){var first=self.mode.getFirstVisiblePage()+1;var last=self.mode.getLastVisiblePage()+1;self.dom.cur.val(first+" - "+last)}window.location.hash=["page",self.mode.index+1,"mode",self.mode.name,"zoom",self.mode.zoom+1].join("/")}})},initializeModes:function(params){var data={dom:{viewport:this.dom.viewport,wrapper:this.dom.wrapper,pages:this.dom.pages,images:this.dom.images},pages:params.pages,zooms:params.zooms,maxZoom:params.maxZoom,pageUrl:params.pageUrl};this.modes={grid:new Docview.Mode.Grid(data),filmstrip:new Docview.Mode.Filmstrip(data),inspect:new Docview.Mode.Inspect(data),"flip-book":new Docview.Mode.FlipBook(data)}},activateMode:function(params){var hash=window.location.hash;if(hash!=""){var mode=hash.match(/mode\/([\w-]+)/)[1];if(typeof this.modes[mode]=="undefined")mode="grid";this.mode=this.modes[mode];this.mode.index=parseInt(hash.match(/page\/(\d+)/)[1])-1;this.mode.zoom=parseInt(hash.match(/zoom\/(\d+)/)[1])-1}else{this.mode=this.modes[params.mode];this.mode.index=params.index;this.mode.zoom=params.zoom}this.mode.activate()},changeMode:function(name){switch(name){case"grid":this.modes[name].zoom=0;break;case"filmstrip":this.modes[name].zoom=1;break;case"inspect":this.modes[name].zoom=3;break;case"flip-book":this.modes[name].zoom=2;break}var index=this.mode.index;this.mode.deactivate();this.mode=this.modes[name];this.mode.index=index;this.mode.activate();this.moveToolbar()},moveToolbar:function(){var scroll=$(window).scrollTop();var offset=this.dom.docview.offset().top;var height=this.dom.docview.height();if(scroll>offset&&scroll<offset+height){this.dom.docview.css("padding-top",this.dom.toolbarWrapper.outerHeight(true));this.dom.toolbarWrapper.css({position:"fixed"})}else{this.dom.docview.css("padding-top",0);this.dom.toolbarWrapper.css({position:"relative"})}}});Docview.Class=Class;return Docview}();Docview.Mode=new Docview.Class({configurate:function(params){this.dom=params.dom;this.zooms=params.zooms;this.maxZoom=params.maxZoom;Docview.Page.url=params.pageUrl;this.pages=$.map(params.pages,function(data,index){return new Docview.Page({id:data.id,h:data.h,w:data.w,downloadUrl:data.downloadUrl,index:index})});this.zoomNums=$.map(this.zooms,function(v,k){return parseInt(k)}).sort(function(a,b){return a-b});this.zoomMin=this.zoomNums[0];this.zoomMax=this.zoomNums.slice(-1)[0]},setValidZoom:function(){var self=this;var zooms=$.grep(this.zoomNums,function(v){return v<=self.maxZoom});var difs=$.map(zooms,function(v){return Math.abs(self.zoom-v)});this.zoom=this.zoomNums[difs.indexOf(Math.min.apply(Math,difs))]},canZoom:function(){return(this.incrementedZoom()||this.zoom)<=this.maxZoom},incZoom:function(){this.zoom=this.incrementedZoom()},incrementedZoom:function(){return this.zoomNums[this.zoomNums.indexOf(this.zoom)+1]},decZoom:function(){this.zoom=this.decrementedZoom()},decrementedZoom:function(){return this.zoomNums[this.zoomNums.indexOf(this.zoom)-1]},resizePages:function(){this.dom.pages.css({width:this.pageWidth(),height:this.pageHeight()});this.dom.images.css("width",this.pageWidth())},pageWidth:function(){return this.zooms[this.zoom]},pageWidthWithIndent:function(){return this.pageWidth()+10},pageHeight:function(){if(!this.cachedMaxPageRatio){var pageRatio=0;for(var i in this.pages){pageRatio=Math.max(pageRatio,this.pages[i].ratio)}this.cachedMaxPageRatio=pageRatio}return Math.ceil(this.cachedMaxPageRatio*this.pageWidth())},pageHeightWithIndent:function(){return this.pageHeight()+10},curPage:function(){return this.pages[this.index]},downloadUrl:function(){var self=this;var zoom=$.grep(this.zoomNums,function(v){return v<=self.maxZoom}).slice(-1)[0];return this.curPage().downloadUrl||this.curPage().url(zoom)}});Docview.Mode.Filmstrip=new Docview.Class({parent:Docview.Mode,init:function(params){this.configurate(params);this.name="filmstrip";this.queue=new Docview.Queue},activate:function(){this.setValidZoom();var self=this;this.dom.viewport.scroll(function(){self.queue.clear();self.load();$(window).trigger("docview-mode-changed")});this.dom.viewport.mousewheel(function(e,d,dx,dy){e.preventDefault();$(this).scrollLeft($(this).scrollLeft()-50*dy)});for(var i in this.pages){(function(page){page.obj.click(function(){self.selectCurPage(page.index);$(window).trigger("docview-select-cur-page")})})(this.pages[i])}this.curPage().obj.addClass("current");this.redraw();this.scrollFastToPage(this.index)},deactivate:function(){this.queue.clear();this.dom.viewport.unbind("scroll");this.dom.viewport.unbind("mousewheel");this.dom.pages.unbind("click");this.curPage().obj.removeClass("current");this.dom.wrapper.css("width","100%");this.dom.viewport.top_scrollbar(false)},zoomIn:function(){if(!this.canZoom()){$(window).trigger("docview-access-denied");return}if(this.zoom<this.zoomMax){this.incZoom();this.redraw();this.scrollFastToPage(this.getFirstVisiblePage())}},zoomOut:function(){if(this.zoom>this.zoomMin){this.decZoom();this.redraw();this.scrollFastToPage(this.getFirstVisiblePage())}},next:function(){this.dom.viewport.stop().animate({scrollLeft:"+="+this.dom.viewport.width()})},prev:function(){this.dom.viewport.stop().animate({scrollLeft:"-="+this.dom.viewport.width()})},setCurPage:function(index){if(index<0)index=0;if(index>this.pages.length-1)index=this.pages.length-1;this.scrollSlowToPage(index)},selectCurPage:function(index){if(index<0)index=0;if(index>this.pages.length-1)index=this.pages.length-1;if(this.index!=index){this.curPage().obj.removeClass("current");this.index=index;this.curPage().obj.addClass("current")}},getFirstVisiblePage:function(){return Math.floor(this.dom.viewport.scrollLeft()/this.pageWidthWithIndent())},getLastVisiblePage:function(){return Math.ceil((this.dom.viewport.width()+this.dom.viewport.scrollLeft())/this.pageWidthWithIndent())-1},scrollSlowToPage:function(index){this.dom.viewport.stop().animate({scrollLeft:index*this.pageWidthWithIndent()})},scrollFastToPage:function(index){this.dom.viewport.scrollLeft(index*this.pageWidthWithIndent())},redraw:function(){this.queue.clear();this.resize();this.load()},resize:function(){this.resizePages();this.dom.wrapper.css("width",this.pages.length*this.pageWidthWithIndent());this.dom.viewport.top_scrollbar(this.pageHeight()>400)},load:function(){var pageWidth=this.pageWidthWithIndent();var border={left:this.dom.viewport.scrollLeft(),right:this.dom.viewport.scrollLeft()+this.dom.viewport.width()};var threshold={left:8*pageWidth,right:8*pageWidth};var border1={left:border.left,right:border.right+threshold.right};var firstPage1=Math.min(Math.max(0,Math.floor(border1.left/pageWidth)),this.pages.length);var lastPage1=Math.min(Math.ceil(border1.right/pageWidth),this.pages.length);for(var i=firstPage1;i<lastPage1;i+=1){this.queue.addPage(this.pages[i],this.zoom)}var border2={left:border.left-threshold.left,right:border.left};var firstPage2=Math.min(Math.max(0,Math.floor(border2.left/pageWidth)),this.pages.length);for(var i=firstPage1-1;i>=firstPage2;i-=1){this.queue.addPage(this.pages[i],this.zoom)}}});$.each(["activate","zoomIn","zoomOut"],function(i,name){var func=Docview.Mode.Filmstrip.prototype[name];Docview.Mode.Filmstrip.prototype[name]=function(){func.apply(this,arguments);$(window).trigger("docview-mode-changed")}});Docview.Mode.FlipBook=new Docview.Class({parent:Docview.Mode,init:function(params){this.configurate(params);this.name="flip-book";this.queue=new Docview.Queue},activate:function(){this.setValidZoom();var self=this;for(var i in this.pages){if(i%2==0){this.pages[i].obj.css({right:0,top:0}).click(function(){self.next()})}else{this.pages[i].obj.css({left:0,top:0}).click(function(){self.prev()})}}this.dom.pages.css("position","absolute");this.showPages();this.redraw()},deactivate:function(){this.queue.clear();this.dom.pages.unbind("click").css("position","relative").show();this.dom.wrapper.css({width:"100%",height:"auto"});this.dom.viewport.top_scrollbar(false)},zoomIn:function(){if(!this.canZoom()){$(window).trigger("docview-access-denied");return}if(this.zoom<this.zoomMax){this.incZoom();this.redraw()}},zoomOut:function(){if(this.zoom>this.zoomMin){this.decZoom();this.redraw()}},animationIsInProgress:false,next:function(){if(this.animationIsInProgress)return;if(this.index+this.index%2-1+2>this.pages.length-1)return;this.animationIsInProgress=true;var index=this.index+this.index%2-1;var p1=this.pages[index];var p2=this.pages[index+1];var p3=this.pages[index+2];var p4=this.pages[index+3];var self=this;if(p4)p4.obj.css("z-index",-1).show();p2.img.height(this.zooms[this.zoom]*p2.ratio);p2.img.animate({width:0},180,function(){p2.obj.hide();p3.img.css({width:0,right:0});p3.obj.show();p3.img.height(self.zooms[self.zoom]*p3.ratio);p3.img.animate({width:self.pageWidth()},180,function(){if(p1)p1.obj.hide();if(p4)p4.obj.css("z-index","auto");p2.img.removeAttr("style");p3.img.removeAttr("style");self.setCurPage(self.index+2);$(window).trigger("docview-mode-changed");self.animationIsInProgress=false})})},prev:function(){if(this.animationIsInProgress)return;if(this.index+this.index%2-1-1<0)return;this.animationIsInProgress=true;var index=this.index+this.index%2-1;var p1=this.pages[index-2];var p2=this.pages[index-1];var p3=this.pages[index];var p4=this.pages[index+1];var self=this;if(p1)p1.obj.show();p3.img.css("right",0);p3.img.height(this.zooms[this.zoom]*p3.ratio);p3.img.animate({width:0},180,function(){p3.obj.hide();p2.img.css("width",0);p2.obj.css("z-index",1).show();p2.img.height(self.zooms[self.zoom]*p2.ratio);p2.img.animate({width:self.pageWidth()},180,function(){if(p4)p4.obj.hide();p3.img.removeAttr("style");p2.img.removeAttr("style");p2.obj.css("z-index","auto");self.setCurPage(self.index-2);$(window).trigger("docview-mode-changed");self.animationIsInProgress=false})})},setCurPage:function(index){if(isNaN(index))return;if(index<0)index=0;if(index>this.pages.length-1)index=this.pages.length-1;if(this.index!=index){this.index=index;this.showPages();this.queue.clear();this.load()}},showPages:function(){this.dom.pages.hide();if(this.index==0){this.pages[this.index].obj.show()}else{var index=this.index+this.index%2-1;this.pages[index].obj.show();if(index+1<this.pages.length)this.pages[index+1].obj.show()}},redraw:function(){this.queue.clear();this.resize();this.load()},resize:function(){this.resizePages();this.dom.wrapper.css({width:2*this.pageWidth(),height:this.pageHeight()});this.dom.viewport.top_scrollbar()},load:function(){var index=Math.max(0,this.index+this.index%2-1);this.queue.addPage(this.pages[index],this.zoom);if(index+1<this.pages.length)this.queue.addPage(this.pages[index+1],this.zoom);var numberOfImagesOnRight=Math.min(8,this.pages.length-index-2);for(var i=1;i<=numberOfImagesOnRight;i+=1){this.queue.addPage(this.pages[index+1+i],this.zoom)}var numberOfImagesOnLeft=Math.min(8,index);for(var i=1;i<=numberOfImagesOnLeft;i+=1){this.queue.addPage(this.pages[index-i],this.zoom)}}});$.each(["activate","zoomIn","zoomOut","prev","setCurPage","next"],function(i,name){var func=Docview.Mode.FlipBook.prototype[name];Docview.Mode.FlipBook.prototype[name]=function(){func.apply(this,arguments);$(window).trigger("docview-mode-changed")}});Docview.Mode.Grid=new Docview.Class({parent:Docview.Mode,init:function(params){this.configurate(params);this.name="grid";this.queue=new Docview.Queue},activate:function(){this.setValidZoom();var self=this;$(window).bind("scroll.docview-grid",function(){self.queue.clear();self.load()});for(var i in this.pages){(function(page){page.obj.click(function(){self.selectCurPage(page.index);$(window).trigger("docview-select-cur-page")})})(this.pages[i])}this.curPage().obj.addClass("current");this.redraw()},deactivate:function(){this.queue.clear();$(window).unbind("scroll.docview-grid");this.dom.pages.unbind("click");this.curPage().obj.removeClass("current")},zoomIn:function(){if(!this.canZoom()){$(window).trigger("docview-access-denied");return}if(this.zoom<this.zoomMax){this.incZoom();this.redraw()}},zoomOut:function(){if(this.zoom>this.zoomMin){this.decZoom();this.redraw()}},selectCurPage:function(index){if(index<0)index=0;if(index>this.pages.length-1)index=this.pages.length-1;if(this.index!=index){this.curPage().obj.removeClass("current");this.index=index;this.curPage().obj.addClass("current")}},redraw:function(){this.queue.clear();this.resizePages();this.load()},load:function(){var win=$(window);var pageHeight=this.pageHeightWithIndent();var pagesInRow=Math.floor(this.dom.viewport.width()/this.pageWidthWithIndent());var viewport={top:win.scrollTop()-this.dom.viewport.offset().top};viewport.bottom=viewport.top+win.height();var threshold={top:3*pageHeight,bottom:3*pageHeight};var border1={top:viewport.top,bottom:viewport.bottom+threshold.bottom};var firstRow1=Math.floor(border1.top/pageHeight);var firstPage1=Math.min(Math.max(0,firstRow1*pagesInRow),this.pages.length);var lastRow1=Math.floor(border1.bottom/pageHeight);var lastPage1=Math.min((lastRow1+1)*pagesInRow,this.pages.length);for(var i=firstPage1;i<lastPage1;i+=1){this.queue.addPage(this.pages[i],this.zoom)}var border2={top:viewport.top-threshold.top,bottom:viewport.top};var firstRow2=Math.floor(border2.top/pageHeight);var firstPage2=Math.min(Math.max(0,firstRow2*pagesInRow),this.pages.length);for(var i=firstPage1-1;i>=firstPage2;i-=1){this.queue.addPage(this.pages[i],this.zoom)}}});$.each(["activate","zoomIn","zoomOut"],function(i,name){var func=Docview.Mode.Grid.prototype[name];Docview.Mode.Grid.prototype[name]=function(){func.apply(this,arguments);$(window).trigger("docview-mode-changed")}});Docview.Mode.Inspect=new Docview.Class({parent:Docview.Mode,init:function(params){this.configurate(params);this.name="inspect";this.queue=new Docview.Queue},activate:function(){this.setValidZoom();this.dom.pages.hide();var self=this;for(var i in this.pages)this.pages[i].obj.click(function(){self.next()});this.curPage().obj.show();this.redraw()},deactivate:function(){this.queue.clear();this.dom.pages.unbind("click").show();this.dom.wrapper.css({width:"100%",height:"auto"});this.dom.images.rotate(0);this.dom.images.css("top","auto");this.dom.viewport.top_scrollbar(false)},zoomIn:function(){if(!this.canZoom()){$(window).trigger("docview-access-denied");return}if(this.zoom<this.zoomMax){this.incZoom();this.redraw()}},zoomOut:function(){if(this.zoom>this.zoomMin){this.decZoom();this.redraw()}},next:function(){this.setCurPage(this.index+1)},prev:function(){this.setCurPage(this.index-1)},rotateLeft:function(){var img=this.curPage().img;var self=this;img.rotate({animateTo:Math.round(img.getRotateAngle()/90)*90-90,duration:500,callback:function(){self.fitIntoTheFrame()}})},rotateRight:function(){var img=this.curPage().img;var self=this;img.rotate({animateTo:Math.round(img.getRotateAngle()/90)*90+90,duration:500,callback:function(){self.fitIntoTheFrame()}})},fitIntoTheFrame:function(){var img=this.curPage().img;var horizontal=this.curPage().w>this.curPage().h;var turned=Math.abs(Math.round(img.getRotateAngle()/90))%2==1;if(horizontal&&turned){img.animate({top:(img.width()-img.height())/2},200)}else{img.animate({top:0},200)}},animationIsInProgress:false,setCurPage:function(index){if(isNaN(index))return;if(index<0)index=0;if(index>this.pages.length-1)index=this.pages.length-1;if(this.index!=index){if(this.animationIsInProgress)return;this.animationIsInProgress=true;var self=this;this.curPage().obj.fadeOut(100,function(){self.curPage().obj.fadeIn(100,function(){self.animationIsInProgress=false})});this.index=index;this.queue.clear();this.load()}},redraw:function(){this.queue.clear();this.resize();this.load();this.fitIntoTheFrame()},resize:function(){this.resizePages();this.dom.wrapper.css({width:this.pageWidthWithIndent(),height:Math.max(this.pageWidthWithIndent(),this.pageHeightWithIndent())});this.dom.viewport.top_scrollbar()},load:function(){this.queue.addPage(this.pages[this.index],this.zoom);var numberOfImagesOnRight=Math.min(4,this.pages.length-1-this.index);for(var i=1;i<=numberOfImagesOnRight;i+=1){this.queue.addPage(this.pages[this.index+i],this.zoom)}var numberOfImagesOnLeft=Math.min(4,this.index);for(var i=1;i<=numberOfImagesOnLeft;i+=1){this.queue.addPage(this.pages[this.index-i],this.zoom)}}});$.each(["activate","zoomIn","zoomOut","prev","setCurPage","next"],function(i,name){var func=Docview.Mode.Inspect.prototype[name];Docview.Mode.Inspect.prototype[name]=function(){func.apply(this,arguments);$(window).trigger("docview-mode-changed")}});Docview.Page=new Docview.Class({init:function(params){for(var i in params)this[i]=params[i];this.ratio=this.h/this.w;this.obj=$("#page-"+this.id);this.img=this.obj.find("img")},url:function(zoom){if(zoom==undefined){return this.img.attr("src")}else{return Docview.Page.url(this.id,zoom)}},load:function(type,zoom,callback){if(type=="fast"){this.img.bind("load",callback).attr("src",this.url(zoom))}else{var self=this;$("<img>").bind("load",function(){self.img.attr("src",$(this).attr("src"));callback()}).attr("src",this.url(zoom))}}});Docview.Queue=new Docview.Class({init:function(){this.fastQueue={objs:[],thread:0};this.slowQueue={objs:[],thread:0}},clear:function(){this.fastQueue.objs=[];this.slowQueue.objs=[]},addPage:function(page,zoom){if(page.url()==page.url(zoom))return;for(var i in this.slowQueue.objs){if(this.slowQueue.objs[i].page.id==page.id)return}if(page.url()==""){this.fastQueue.objs.push({page:page,zoom:0});this.load("fast")}this.slowQueue.objs.push({page:page,zoom:zoom});this.load("slow")},load:function(type){var queue=this[type+"Queue"];if(queue.objs.length==0||queue.thread==this.getMaxThread(type))return;var obj=queue.objs.shift();queue.thread+=1;var self=this;obj.page.load(type,obj.zoom,function(){queue.thread-=1;self.load(type)})},getMaxThread:function(type){var queue=this[type+"Queue"];switch(queue.objs[queue.objs.length-1].zoom){case 0:return 8;case 1:return 6;case 2:return 4;default:return 2}}});